import type { Ref } from 'vue';
import { inject, onBeforeUnmount, ref, unref, watch } from 'vue';
import { apiSymbol, mapSymbol } from '../inject';
import { Marker, MarkerOptions } from '@/types';

type GoogleComponentsKey = 'Marker' | 'Polyline' | 'Polygon' | 'Rectangle' | 'Circle';

type GoogleMapComponentType<T> = T extends 'Marker'
  ? Marker
  : T extends 'Polyline'
    ? google.maps.Polyline
    : T extends 'Polygon'
      ? google.maps.Polygon
      : T extends 'Rectangle'
        ? google.maps.Rectangle
        : T extends 'Circle'
          ? google.maps.Circle
          : never;

type GoogleMapComponentOptions<T> = T extends 'Marker'
  ? MarkerOptions
  : T extends 'Polyline'
    ? google.maps.PolylineOptions
    : T extends 'Polygon'
      ? google.maps.PolygonOptions
      : T extends 'Rectangle'
        ? google.maps.RectangleOptions
        : T extends 'Circle'
          ? google.maps.CircleOptions
          : never;

export function useMap<T extends GoogleComponentsKey>(
  key: T,
  events: string[],
  options: Ref<GoogleMapComponentOptions<T>>,
  // FIXME: emit type
  emit: (event: any, ...args: any) => void,
): Ref<GoogleMapComponentType<T> | undefined> {
  const component = ref<GoogleMapComponentType<T>>();
  const map = inject(mapSymbol, ref());
  const api = inject(apiSymbol, ref());

  watch([map, options], ([_, newOptions]) => {
    if (!map.value || !api.value)
      return;

    // DEV: Watch CofMap
    if (__DEV__) {
      /* eslint-disable no-console */
      console.log('map:', map.value);
      console.log('api:', api?.value);
      /* eslint-enable */
    }

    const marker = new api.value.Marker({
      ...unref(newOptions),
      map: map.value,
    });

    if (component.value) {
    // FIXME: setOptions type error
      component.value.setOptions(
        newOptions as (
          MarkerOptions
          & google.maps.PolylineOptions
          & google.maps.PolygonOptions
          & google.maps.RectangleOptions
          & google.maps.CircleOptions
        ) | null);
    }
    else {
      component.value = marker as GoogleMapComponentType<typeof key>;

      events.forEach((event) => {
        component.value?.addListener(event, (e: google.maps.MapMouseEvent | undefined) => emit(event, e));
      });
    }
  },
  {
    deep: true,
  });

  onBeforeUnmount(() => {
    if (component.value)
      api.value?.event.clearInstanceListeners(component.value);
  });

  return component;
}
